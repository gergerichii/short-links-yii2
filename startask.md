Для реализации сбора статистики о количестве переходов, включая общее количество и разбивку по дням, можно сделать следующее:.

Добавляется таблица для хранения статистики. Она будет содержать поля для токена сокращённой ссылки, даты перехода и количества переходов за эту дату. Для оптимизации запросов создаётся составной индекс по токену и дате. Это позволяет эффективно агрегировать данные по конкретной ссылке и получать статистику за каждый день.

Чтобы учесть нагрузку до 5,000 запросов в секунду, учёт переходов выносится в асинхронную очередь (например, RabbitMQ, Redis Streams). При каждом переходе создаётся событие, которое помещается в очередь. Это позволяет быстро обрабатывать запросы перенаправления, не нагружая базу данных.

События из очереди обрабатываются консольными командами по крону. Каждое событие добавляет один переход к соответствующему токену и дате. Если запись для этой даты ещё не существует, она создаётся; иначе просто увеличивается счётчик переходов. Для повышения производительности можно группировать события по ссылкам и датам перед записью в базу.

Обновление статистики в базе может происходить с некоторой задержкой (до минуты), поэтому можно использовать кэш для хранения промежуточных данных. Например, количество переходов за текущий день можно временно хранить в Redis и периодически записывать в базу.

Для отображения общего количества переходов выполняется запрос с суммированием данных по токену. Для статистики по дням используется группировка записей по дате. Эти данные извлекаются из базы данных и выводятся в удобном виде.